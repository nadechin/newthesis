\chapter{実装}
\label{impl}

本章では，低対話型Honeypotと高対話型Honeypotの設置環境についても示し，~\ref{meth:appr}節で述べた手法を用いて純正のHoneypotにどのようなコマンドを実装し，Honeypot特有の異常な挙動を修正したのかを説明する．

\section{実装環境}
本研究で実装するシステムを構成するためのハードウェアおよびソフトウェアについて説明する．表\ref{table:imple}に詳細なバージョンを示す．
\label{impl:env}

% -------------------
\vspace{3mm}
%\newlength{\myheight}
\setlength{\myheight}{10mm}
\begin{table}[h]
 \caption{実装環境}
 \label{table:imple}
 \centering
  \begin{tabular}{|c|c|c|}
   \hline
   ハードウェア/ソフトウェア & 実装環境 & Version(date)  \\
    \hline \hline
     \parbox[c][\myheight][c]{0cm}{} 純正のCowrie  & CentOS5 & 1．4．0  \\
     \hline
     \parbox[c][\myheight][c]{0cm}{} 修正済みのCowrie  & CentOS5 & 1．4．0（self made）  \\
     \hline
     \parbox[c][\myheight][c]{0cm}{} Honeywall  & CentOS5 & 1．4  \\
     \hline
  \end{tabular}
\end{table}
\vspace{7mm}
% --------------------

%本研究で実装するシステムを構成するためのハードウェアおよびソフトウェアについて説明する．表\ref{table:usedversion}に詳細なバージョンを示す．

%\begin{table}[!hbtp]
%    \begin{center}
%        \caption{使用ソフトウェアおよびハードウェアのバージョン}
 %       \begin{tabular}{|c|c|c|}
 %           \hline
 %           ハードウェア/ソフトウェア &　実装環境 & バージョン \\
%            \hline
%            \hline
%            シングルボードコンピュータ & Raspberry Pi3 & ModelB  \\
%            \hline
%            3Dプリンタ & simple metal & 1403  \\
%            \hline
%            3Dプリンタ制御 & Octoprint & 1．3．0  \\
%            \hline
%            Blockchainクライアント & Geth & 1．5．8  \\
%            \hline
%            アプリケーションフレームワーク & laravel & 5．2  \\
%            \hline
%        \end{tabular}
%        \label{table:usedversion}
%    \end{center}
%\end{table}

%\subsection{ハードウェア}
%\label{impl:hardware}
%3Dプリンタを制御およびBlockchainへの製造情報の保存を行うためのシングルボードコンピュータとしてRaspberry Pi3を用いる\cite{RaspberryPi}．Raspberry Pi3は安価に購入でき，LinuxベースのOSによって動作する．そのため，Blockchainノードとして正常に動作せることが可能である．また，USBポートで3Dプリンタを接続し，制御するソフトウェアもいくつか存在する．


%今回の実装では，3Dプリンタとしてprintrbot社のsimple metalを用いる\cite{Printrbot}．simple metalはSLA法の個人向け3Dプリンタであり，比較的安価なモデルである．USBポートによってコンピュータを接続することで制御を行うことができる．

%\subsection{3Dプリンタの制御}
%\label{impl:ctl3dprinter}

%本システムでは，3Dプリンタを制御するシステムとして，Octoprint\cite{octoprint}を用いる．Octoprintはオープンソースの3Dプリンタ制御ソフトウェアであり，Raspberry Piに導入し，Webインターフェースよりプリントを行うことができる．3Dモデルの形式は一般的なSTL形式ではなく，3Dプリントを実際に行う際の制御コマンド体系であるG-CODE形式で入力を行う．多くの機能がRESTfulなAPIで実装されており，3Dプリンタを制御しながら他のアプリケーションへ容易に連携させることが可能である．

%\subsection{Blockchainへのデータ保存}
%\label{impl:savedata}

%本システムでは，Blockchainに製造情報を保存する方法として，\ebc{}のCAとして保存する．EthereumはBlockchainを用いたアプリケーション開発プラットフォームとしては最も一般的に使われている．そのため本システムで独自にBlockchainを構築し十分にスケールさせなくとも，Blockchainの高改ざん耐性を利用することができる．また，Ethereum上で動作するプログラムはチューリング完全性を持つため，データ構造などを比較的自由に記述することができる．Ethereumのクライアントとしては，Go言語で実装されたGeth\cite{geth}を用いる．GethはJSON-RPCによるAPIが実装されており，プログラムから制御できる．

%\subsection{システム全体}
%\label{impl:system}
%本システムは，本節で述べた複数のソフトウェアを連携させて動作する．今回は，全体をコントロールするインターフェイスとしてWebブラウザからアクセスすることを想定した．そこで，PHPによるWebアプリケーションフレームワークであるLaravel\cite{laravel}を用いて実装した．Laravelは2012年にリリースされてから急速に普及しているPHPフレームワークであり，オープンソース化されている．

%\section{データ登録システム}

%ユーザが3Dプリントを行う際のシーケンス図を以下に示す．ユーザが3Dプリントを命令した際にJSON RPCよりEthereum上にコントラクトをデプロイし，そのCAのアドレスをプリントされる製造物のIDとする．このIDを製造物の内部にRFIDを埋め込むなどで製造物と紐付け，製造物からコントラクトを呼び出すことができ，追跡可能性を担保する．デプロイされたコントラクトはマイナーによって実際にブロックへ格納され，後日改ざんすることは困難になる．

%\begin{figure}[h]
%    \begin{center}
%        \includegraphics[scale=0．4]{．/img/si-kensu．pdf}
%        \caption{システムシーケンス図}
%        \label{img:sequence}
%    \end{center}
%\end{figure}

%\subsection{保存するデータ構造}
%製造物の製造責任の追及，および知的財産権の保証には，製造物の設計図となる3Dモデル，3Dモデルの設計者，製造者，製造日時の記録が必要である．3Dモデルの設計者の担保を行うためには3Dモデルにデジタル署名が埋め込まれている必要があるが，現状では埋め込まれていない．また，製造日時については，P2Pネットワークにおいて特定のノードが述べる日時が正しいことを保証することはできないため，製造時に保存したとしても信頼出来るデータとは限らない．そこで本実装では3Dモデル，製造物の名前，製造者のみを保存する．Ethereumでは3Dモデルを直接Blockchainに保存することはEthereum上に保存できるデータ容量の制限により不可能なため，3Dモデルのハッシュ値を保存する．ハッシュ値を参照することで，製造物をプリントした3Dモデルと同様のデータであることを検証可能とする．また，製造者のデータとしてはEthereumのアドレスを使う．

%\begin{table}[!hbtp]
%    \begin{center}
%        \caption{保存するデータ構造}
%        \begin{tabular}{|c|c|c|}
%            \hline
%            Label & データサイズ &  概要 \\
%            \hline
%            \hline
%            name & 最大32byte & 製造物の名前  \\
%            \hline
%            3d data hash & 32byte & SHA256を用いた3Dモデルのハッシュ値  \\
%            \hline
%            maker & 32byte  & 製造者のEthereumアドレス  \\
%            \hline
%        \end{tabular}
%        \label{table:dataconstracture}
%    \end{center}
%\end{table}

\subsection{純正のHoneypotで未実装のコマンドの実装}
\label{impl:ImplBusyBox}
本研究において純正のHoneypotはCowrie\cite{cowrie}を使用し，実際のShellには実装されているが，純正のHoneypotで未実装のコマンドについてはBusyBox\cite{busybox}に含まれるコマンドの実装を行なった．~\ref{tech:BusyBox}や~\ref{Cowrie}で紹介した通り，BusyBoxに含まれるコマンドの種類が219ある中で，Cowrieの実装コマンド数は92しか存在しない．この差分をPythonで実装する． \\
またBusyBoxに含まれるコマンドとCowrieの実装コマンドの一覧を表\ref{table:command}に示す． \\
% -------------------

\usepackage{longtable}
\usepackage{geometry}
\geometry{textwidth=160mm, textheight=225mm}
 
\begin{document}
 
\begin{center}
\large{\textbf{実装コマンド一覧}
\end{center}

BusyBoxに含まれるコマンドとCowrieの実装コマンドの一覧
 
\begin{longtable}{llp{60mm}p{60mm}}
  \caption{実装コマンド一覧}
  \label{table:command} \\
  %------ 最初のページの表の最上部 ----
  \hline
  Busyboxに含まれるコマンド & Cowrieの実装コマンド \\ \hline\hline
  \endfirsthead
  %------ 2ページ以降の表の最上部 ----
  \multicolumn{4}{r}{前ページからの続き} \\ \hline
  Busyboxに含まれるコマンド & Cowrieの実装コマンド \\ \hline\hline
  \endhead
  %----- ページの表の最下部 --------
  \hline
  \multicolumn{4}{r}{次ページに続く} \\
  \endfoot
  %----- 最終ページの表の最下部 --------
  \hline
  \multicolumn{4}{r}{以上} \\
  \endlastfoot

     adduser & acpid  \\
     \hline
     alias & adjtimex  \\
     \hline
     apt-get & ar  \\
     \hline
     base64 & arp  \\
     \hline
     bash & arping  \\
     \hline
     busybox & ash  \\
     \hline
     cat & awk  \\
     \hline
     cd & basename  \\
     \hline
     chattr & blockdev  \\
     \hline
     chgrp & brctl  \\
     \hline
     chmod & bunzip2  \\
     \hline
     chown & bzcat  \\
     \hline
     clear & bzip2  \\
     \hline
     cp & cal  \\
     \hline
     curl & cat  \\
     \hline
     date & chgrp  \\
     \hline
     dd & chmod  \\
     \hline
     dget & chown  \\
     \hline
     dir & chpasswd \\
     \hline
     du & chroot \\
     \hline
     echo & chvt \\
     \hline
     egrep & clear \\
     \hline
     env & cmp \\
     \hline
     ethtool & cp \\
     \hline
     exit & cpio \\
     \hline
     export & crond \\
     \hline
     fgrep & crontab \\
     \hline
     free & cttyhack \\
     \hline
     ftpget & cut \\
     \hline
     gcc & date \\
     \hline
     grep & dc \\
     \hline
     halt & dd \\
     \hline
     head & deallocvt \\
     \hline
     help & depmod \\
     \hline
     history & devmem \\
     \hline
     hostname & df \\
     \hline
     id & diff \\
     \hline
     ifconfig & dirname \\
     \hline
     iptables & dmesg \\
     \hline
     jobs & dnsdomainname \\
     \hline
     kill & dos2unix \\
     \hline
     killall & dpkg \\
     \hline
     killall5 & dpkg-deb \\
     \hline
     last & du \\
     \hline
     logout & dumpkmap \\
     \hline
     ls & dumpleases \\
     \hline
     mkdir & echo \\
     \hline
     mv & ed \\
     \hline
     nc & egrep \\
     \hline
     netstat & env \\
     \hline
     nohup & expand \\
     \hline
     passwd & expr \\
     \hline
     perl & FALSE \\
     \hline
     php & fdisk \\
     \hline
     ping & fgrep \\
     \hline
     pkill & find \\
     \hline
     poweroff & fold \\
     \hline
     printf & free \\
     \hline
     ps & freeramdisk \\
     \hline
     pwd & fstrim \\
     \hline
     python & ftpget \\
     \hline
     reboot & ftpput \\
     \hline
     reset & getopt \\
     \hline
     rm & getty \\
     \hline
     rmdir & grep \\
     \hline
     scp & groups \\
     \hline
     service & gunzip \\
     \hline
     set & gzip \\
     \hline
     sh & halt \\
     \hline
     shutdown & head \\
     \hline
     sleep & hexdump \\
     \hline
     ssh & hostid \\
     \hline
     su & hostname \\
     \hline
     sudo & httpd \\
     \hline
     tail & hwclock \\
     \hline
     tar & id \\
     \hline
     tftp & ifconfig \\
     \hline
     touch & ifdown \\
     \hline
     ulimit & ifup \\
     \hline
     umask & init \\
     \hline
     uname & insmod \\
     \hline
     unset & ionice \\
     \hline
     uptime & ip \\
     \hline
     useradd & ipcalc \\
     \hline
     users & kill \\
     \hline
     w & killall \\
     \hline
     wget & klogd \\
     \hline
     which & last \\
     \hline
     who & less \\
     \hline
     whoami & ln \\
     \hline
     yes & loadfont \\
     \hline
     yum & loadkmap \\
     \hline
      NULL& logger \\
     \hline
      NULL& login \\
     \hline
      NULL& logname \\
     \hline
      NULL& logread \\
     \hline
      NULL& losetup \\
     \hline
      NULL& ls \\
     \hline
      NULL& lsmod \\
     \hline
      NULL& lzcat \\
     \hline
      NULL& lzma \\
     \hline
      NULL& lzop \\
     \hline
      NULL& lzopcat \\
     \hline
      NULL& md5sum \\
     \hline
      NULL& mdev \\
     \hline
      NULL& microcom \\
     \hline
      NULL& mkdir \\
     \hline
      NULL& mkfifo \\
     \hline
      NULL& mknod \\
     \hline
      NULL& mkswap \\
     \hline
      NULL& mktemp \\
     \hline
      NULL& modinfo \\
     \hline
      NULL& modprobe \\
     \hline
      NULL& more \\
     \hline
      NULL& mount \\
     \hline
      NULL& mt \\
     \hline
      NULL& mv \\
     \hline
      NULL& nameif \\
     \hline
      NULL& nc \\
     \hline
      NULL& netstat \\
     \hline
      NULL& nslookup \\
     \hline
      NULL& od \\
     \hline
      NULL& openvt \\
     \hline
      NULL& passwd \\
     \hline
      NULL& patch \\
     \hline
      NULL& pidof \\
     \hline
      NULL& ping \\
     \hline
      NULL& ping6 \\
     \hline
      NULL& pivot_root \\
     \hline
      NULL& poweroff \\
     \hline
      NULL& printf \\
     \hline
      NULL& ps \\
     \hline
      NULL& pwd \\
     \hline
      NULL& rdate \\
     \hline
      NULL& readlink \\
     \hline
      NULL& realpath \\
     \hline
      NULL& reboot \\
     \hline
      NULL& renice \\
     \hline
      NULL& reset \\
     \hline
      NULL& rev \\
     \hline
      NULL& rm \\
     \hline
      NULL& rmdir \\
     \hline
      NULL& rmmod \\
     \hline
      NULL& route \\
     \hline
      NULL& rpm \\
     \hline
      NULL& rpm2cpio \\
     \hline
      NULL& run-parts \\
     \hline
      NULL& sed \\
     \hline
      NULL& seq \\
     \hline
      NULL& setkeycodes \\
     \hline
      NULL& setsid \\
     \hline
      NULL& sh \\
     \hline
      NULL& sha1sum \\
     \hline
      NULL& sha256sum \\
     \hline
      NULL& sha512sum \\
     \hline
      NULL& sleep \\
     \hline
      NULL& sort \\
     \hline
      NULL& start-stop-daemon \\
     \hline
      NULL& stat \\
     \hline
      NULL& static-sh \\
     \hline
      NULL& strings \\
     \hline
      NULL& stty \\
     \hline
      NULL& su \\
     \hline
      NULL& sulogin \\
     \hline
      NULL& swapoff \\
     \hline
      NULL& swapon \\
     \hline
      NULL& switch_root \\
     \hline
      NULL& sync \\
     \hline
      NULL& sysctl \\
     \hline
      NULL& syslogd \\
     \hline
      NULL& tac \\
     \hline
      NULL& tail \\
     \hline
      NULL& tar \\
     \hline
      NULL& taskset \\
     \hline
      NULL& tee \\
     \hline
      NULL& telnet \\
     \hline
      NULL& telnetd \\
     \hline
      NULL& test \\
     \hline
      NULL& tftp \\
     \hline
      NULL& time \\
     \hline
      NULL& timeout \\
     \hline
      NULL& top \\
     \hline
      NULL& touch \\
     \hline
      NULL& tr \\
     \hline
      NULL& traceroute \\
     \hline
      NULL& traceroute6 \\
     \hline
      NULL& TRUE \\
     \hline
      NULL& tty \\
     \hline
      NULL& tunctl \\
     \hline
      NULL& udhcpc \\
     \hline
      NULL& udhcpd \\
     \hline
      NULL& umount \\
     \hline
      NULL& uname \\
     \hline
      NULL& uncompress \\
     \hline
      NULL& unexpand \\
     \hline
      NULL& uniq \\
     \hline
      NULL& unix2dos \\
     \hline
      NULL& unlzma \\
     \hline
      NULL& unlzop \\
     \hline
      NULL& unxz \\
     \hline
      NULL& unzip \\
     \hline
      NULL& uptime \\
     \hline
      NULL& usleep \\
     \hline
      NULL& uudecode \\
     \hline
      NULL& uuencode \\
     \hline
      NULL& vconfig \\
     \hline
      NULL& vi \\
     \hline
      NULL& watch \\
     \hline
      NULL& watchdog \\
     \hline
      NULL& wc \\
     \hline
      NULL& wget \\
     \hline
      NULL& which \\
     \hline
      NULL& who \\
     \hline
      NULL& whoami \\
     \hline
      NULL& xargs \\
     \hline
      NULL& xz \\
     \hline
      NULL& xzcat \\
     \hline
      NULL& yes \\
     \hline
      NULL& zcat \\
     \hline
\end{longtable}
%\vspace{3mm}
%\setlength{\myheight}{10mm}
%\begin{table}[h]
% \caption{実装コマンド一覧}
% \label{table:command}
% \centering
%  \begin{tabular}{|c|c|}
%   \hline
%   Busyboxに含まれるコマンド & Cowrieの実装コマンド  \\
%    \hline \hline
%  \end{tabular}
%\end{table}
%\vspace{7mm}
% --------------------

%%% Local Variables:
%%% mode: japanese-latex
%%% TeX-master: "．．/bthesis"
%%% End:
